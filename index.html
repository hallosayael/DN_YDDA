<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
<title>Debit Note Makan Siang</title>
<style>
  /* ==== FIX TEKS INPUT KEGUNTING DI BAWAH ==== */
:root{
  --inp-h: 40px;          /* tinggi input yang nyaman (38‚Äì42px juga oke) */
  --inp-fs: 14px;         /* ukuran font input */
}

/* beri ruang ekstra pada sel agar input tidak kepres */
th, td { padding: 10px 10px; }

/* kunci metrik input agar konsisten di semua zoom/OS */
input.money{
  font-size: var(--inp-fs);
  height: var(--inp-h);
  line-height: 1.25;      /* jangan 1.0; bikin lebih lega */
  padding: 8px 12px 10px; /* ekstra 2px di bawah supaya aman */
  border-radius: 8px;
  -webkit-appearance: none;
  appearance: none;
  display: block;         /* hindari baseline aneh di inline-input */
}

/* saat print kita balik ke auto agar tidak kepotong */
@media print {
  input.money{
    height: auto !important;
    line-height: 1.2 !important;
    padding: 0 !important;
  }
}

  :root {
    --bg:#f8fafc; --card:#fff; --line:#e5e7eb;
    --ink:#0f172a; --muted:#64748b;
    --accent:#fef3c7; --hi:#fef08a; --blue:#e0f2fe;
  }
  * { box-sizing:border-box; }
  body {
    font-family: Inter, system-ui, sans-serif;
    background: var(--bg);
    color: var(--ink);
    margin: 0;
    padding: 16px;
  }

  .wrap {
    max-width: 1120px;
    margin: auto;
    background: var(--card);
    border: 1px solid var(--line);
    border-radius: 12px;
    box-shadow: 0 8px 18px rgba(2,6,23,.06);
    overflow: hidden;
  }

  header { padding: 16px; border-bottom: 1px solid var(--line); text-align:center; }
  h1 { margin: 0; font-size: 1.2rem; }

  .toolbar {
    display: flex; flex-wrap: wrap; gap: 6px;
    align-items: center; justify-content: space-between;
    padding: 10px 16px; border-bottom: 1px dashed var(--line);
  }

  /* ====== Editable Title ====== */
.title h1{
  margin: 0;
  font-size: 1.2rem;
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  align-items: baseline;
}

#titleExtra{
  border: none;
  border-bottom: 2px solid var(--line);
  background: transparent;
  font: inherit;
  padding: 0 4px 2px;
  min-width: 160px;
  text-transform: uppercase;       /* CAPSLOCK otomatis */
  outline: none;
}
#titleExtra::placeholder{ color: var(--muted); }

/* Mobile rapih */
@media (max-width: 768px){
  .title h1{ font-size: 1rem; }
  #titleExtra{ min-width: 120px; }
}

/* Print & Capture-friendly: tampil seperti teks polos */
@media print{
  #titleExtra{
    border: none !important;
    background: transparent !important;
    padding: 0 !important;
  }
}


  .btn {
    padding: 8px 10px;
    border: 1px solid var(--line);
    border-radius: 8px;
    background: #fff;
    cursor: pointer;
    font-size: 0.9rem;
  }
  .btn:hover { background: #f8fafc; }

  select {
    padding: 6px 8px;
    border: 1px solid var(--line);
    border-radius: 8px;
  }

  .table-wrap {
    width: 100%;
    overflow-x: auto;
    scrollbar-width: thin;
    -webkit-overflow-scrolling: touch;
  }

  table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    table-layout: auto;
    min-width: 650px;
  }

  th, td {
    border-bottom: 1px solid var(--line);
    padding: 8px 10px;
    text-align: right;
    vertical-align: middle;
    white-space: nowrap;
  }
  th:first-child, td:first-child { text-align: left; }
  thead th { background: #fff; position: sticky; top: 0; z-index: 1; }

  input.money {
    width: 100%; padding: 6px 8px;
    border: 1px solid var(--line);
    border-radius: 6px;
    text-align: right;
    text-transform: uppercase; /* üîπ auto CAPSLOCK */
  }
  td:first-child input.money { text-align: left; text-transform: uppercase; }

  .row-label { background: var(--accent); font-weight: 600; }
  .row-net { background: var(--hi); font-weight: 700; }
  .col-total { background: var(--blue); font-weight: 600; }
  .note { font-size: 0.8rem; color: var(--muted); padding: 8px 16px 4px; }

  /* üîπ Bagian Bayar ke */
  .payto {
    padding: 16px;
    display: flex;
    align-items: center;
    gap: 10px;
    border-top: 2px solid var(--line);
    background: #fffbea;
  }
  .payto label {
    font-weight: 800;
    font-size: 1.1rem;
    text-transform: uppercase;
  }
  .payto input {
    flex: 1;
    padding: 10px 12px;
    border: 2px solid var(--line);
    border-radius: 8px;
    font-weight: 700;
    font-size: 1.1rem;
    text-transform: uppercase; /* CAPSLOCK */
    background: #fffdf0;
  }

  /* Saat proses capture: nonaktifkan sticky & overflow agar gambar utuh */
  body.capturing thead th { position: static !important; }
  body.capturing .table-wrap { overflow: visible !important; }
  body.capturing input.money { caret-color: transparent; }

  /* RESPONSIVE */
  @media (max-width: 768px) {
    body { padding: 8px; }
    .btn { flex: 1; min-width: 48%; font-size: 0.8rem; }
    select { font-size: 0.8rem; }
    h1 { font-size: 1rem; }
    table { font-size: 0.85rem; }
    th, td { padding: 6px; }
    .payto { flex-direction: column; align-items: flex-start; }
    .payto input { width: 100%; }
  }

  /* PRINT MODE */
  @media print {
    @page { size: A4 landscape; margin: 8mm; }
    body { padding: 0; background: #fff; font-size: 11px; }
    .wrap { max-width: none; box-shadow: none; border: none; border-radius: 0; }
    .toolbar, .note { display: none !important; }
    .table-wrap { overflow: visible; }
    thead th { position: static; }
    input.money {
      border: none !important; background: transparent !important;
      text-align: right; padding: 0 !important;
    }
    td:first-child input.money { text-align: left; }
    .col-total, .row-label, .row-net { background: #fff !important; }
    .payto {
      border-top: 2px solid #000;
      background: #fff;
      padding-top: 10px;
    }
    .payto label, .payto input {
      font-weight: 800;
      font-size: 1.2rem;
      text-transform: uppercase;
      border: none !important;
      background: transparent !important;
    }
  }
</style>
</head>
<body>
<div class="wrap" id="capture-root">
  <header class="title">
  <h1>
    Debit Note
    <input id="titleExtra" type="text" placeholder="ISI DI SINI" />
  </h1>
</header>

  <div class="toolbar">
    <div style="display:flex;gap:6px;flex-wrap:wrap;">
      <button class="btn" id="addRow">+ Tambah Menu</button>
      <button class="btn" id="addPerson">+ Tambah Nama</button>
      <button class="btn" id="clearAll">üßπ Bersihkan</button>
      <button class="btn" id="printBtn">üñ®Ô∏è Print / PDF</button>
      <!-- üîπ Tombol Capture JPG -->
      <button class="btn" id="jpgBtn">üì∏ JPG</button>
    </div>
    <div>
      Basis Diskon:
      <select id="basis"><option>TOTAL</option><option>SUBTOTAL</option></select>
    </div>
  </div>

  <div class="table-wrap">
    <table id="tbl">
      <thead>
        <tr id="hdr">
          <th>MENU</th>
          <th>ICHA</th><th>WISI</th><th>SARAH</th><th>MOLI</th><th>SANTI</th><th>ANGEL</th>
          <th class="col-total">TOTAL</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
      <tfoot>
        <tr class="row-label" id="rSub"><td>SUBTOTAL (menu)</td></tr>
        <tr class="row-label" id="rOng"><td>ONGKIR (TOTAL)</td></tr>
        <tr class="row-label" id="rLain"><td>LAIN-LAIN (TOTAL)</td></tr>
        <tr class="row-label" id="rTot"><td>TOTAL (Subtotal + Ongkir + Lain)</td></tr>
        <tr class="row-label" id="rPct"><td>% (berdasar <span id="badge">SUBTOTAL</span>)</td></tr>
        <tr class="row-label" id="rDisc"><td>DISC (TOTAL)</td></tr>
        <tr class="row-net"  id="rNet"><td>NET = Total ‚àí Disc</td></tr>
      </tfoot>
    </table>
  </div>

  <div class="note">
    Ketik <b>10000</b>, <b>10.000</b>, atau <b>10,000</b> di kolom ongkir/diskon ‚Äî semua dibaca sebagai 10.000.
  </div>

  <div class="payto">
    <label for="payto">Bayar ke:</label>
    <input type="text" id="payto" placeholder="NAMA / NOMOR REKENING / E-WALLET">
  </div>
</div>

<!-- pakai CDNJS, tanpa integrity -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"
        referrerpolicy="no-referrer">
</script>

<script>
const fmtID = new Intl.NumberFormat('id-ID');
const fmt = n => fmtID.format(Math.round(n));
const cleanNumber = v => {
  const s = (v ?? '').toString().replace(/[^\d\-]/g,'');
  if (!s || s === '-' || s === '--') return 0;
  return parseInt(s,10) || 0;
};

let names = ["ICHA","WISI","SARAH","MOLI","SANTI","ANGEL"];
const tbody = document.getElementById('tbody');

function rebuildHeader(){
  document.getElementById('hdr').innerHTML =
    '<th>MENU</th>' + names.map(n=>`<th>${n}</th>`).join('') + '<th class="col-total">TOTAL</th>';
  // üîπ aktifkan rename setelah header jadi
  hookHeaderRename();
}
function rebuildFooter(){
  const rows = [
    ['rSub', false],
    ['rOng',  true],
    ['rLain', true],
    ['rTot', false],
    ['rPct', false],
    ['rDisc', true],
    ['rNet', false],
  ];
  rows.forEach(([id,withInp])=>{
    const tr = document.getElementById(id);
    tr.querySelectorAll('td:not(:first-child)').forEach(td=>td.remove());
    names.forEach((_,i)=>{
      const td = document.createElement('td'); td.id = `${id}_${i}`; tr.appendChild(td);
    });
    const tdTot = document.createElement('td'); tdTot.className='col-total';
    if(withInp){
      const inp = document.createElement('input');
      inp.type = 'text'; inp.className='money'; inp.placeholder='0'; inp.id = `${id}_total`;
      const handle = e => { e.target.dataset.value = String(cleanNumber(e.target.value)); recalc(); };
      inp.addEventListener('input', handle); inp.addEventListener('change', handle); inp.addEventListener('keyup', handle);
      tdTot.appendChild(inp);
    } else tdTot.id = `${id}_total`;
    tr.appendChild(tdTot);
  });
}

function addRow(label=''){
  const tr = document.createElement('tr');
  const first = document.createElement('td');
  const nameIn = document.createElement('input');
  nameIn.type='text'; nameIn.className='money';
  nameIn.placeholder='Nama menu';
  nameIn.style.textAlign='left';
  nameIn.style.textTransform='uppercase';
  nameIn.value=label;
  first.appendChild(nameIn); tr.appendChild(first);
  names.forEach(()=>{
    const td = document.createElement('td');
    const inp = document.createElement('input');
    inp.type='text'; inp.className='money'; inp.placeholder='0';
    const handle = e => { e.target.dataset.value = String(cleanNumber(e.target.value)); recalc(); };
    inp.addEventListener('input', handle); inp.addEventListener('change', handle); inp.addEventListener('keyup', handle);
    td.appendChild(inp); tr.appendChild(td);
  });
  const total = document.createElement('td'); total.className='col-total'; total.textContent='0'; tr.appendChild(total);
  tbody.appendChild(tr);
}

function addPerson(){
  const nm = prompt('Nama orang baru?'); if(!nm) return;
  names.push(nm.toUpperCase());
  rebuildHeader(); rebuildFooter();
  [...tbody.rows].forEach(tr=>{
    const td = document.createElement('td');
    const inp= document.createElement('input');
    inp.type='text'; inp.className='money'; inp.placeholder='0';
    const handle = e => { e.target.dataset.value = String(cleanNumber(e.target.value)); recalc(); };
    inp.addEventListener('input', handle); inp.addEventListener('change', handle); inp.addEventListener('keyup', handle);
    td.appendChild(inp);
    tr.insertBefore(td, tr.lastElementChild);
  });
  recalc();
}

function clearAll(){
  document.querySelectorAll('input.money').forEach(i=>{ i.value=''; i.dataset.value='0'; });
  recalc();
}

function recalc(){
  const per = new Array(names.length).fill(0);

  // --- Hitung subtotal per orang & total per baris ---
  [...tbody.rows].forEach(tr=>{
    const inputs = [...tr.querySelectorAll('td input.money')].slice(1);
    const vals = inputs.map(i => cleanNumber(i.value || i.dataset.value));
    const rowTot = vals.reduce((a,b)=>a+b,0);
    tr.lastElementChild.textContent = fmt(rowTot);
    vals.forEach((v,i)=> per[i]+=v);
  });

  // --- Tulis SUBTOTAL row ---
  const gSub = per.reduce((a,b)=>a+b,0);
  per.forEach((v,i)=> (document.getElementById(`rSub_${i}`).textContent = fmt(v)));
  document.getElementById('rSub_total').textContent = fmt(gSub);

  // --- Siapa yang aktif (punya pesanan) untuk pembagian ongkir/lain ---
  const activeIdx = per.map((v,i)=> v>0?i:-1).filter(i=>i>=0);
  const nAct = activeIdx.length || 1;

  // helper ambil angka dari input footer
  const getTotalFrom = id => {
    const el = document.getElementById(`${id}_total`);
    if (!el) return 0;
    return cleanNumber(el.value || el.dataset.value);
  };

  const ongTot  = getTotalFrom('rOng');
  const lainTot = getTotalFrom('rLain');
  const discTot = getTotalFrom('rDisc');

  // --- Bagi ongkir & lain rata hanya ke yang aktif ---
  const splitEven = total => {
    const arr = new Array(names.length).fill(0);
    if(total===0 || nAct===0) return arr;
    const base = Math.floor(total / nAct);
    let rem = total - base*nAct;
    activeIdx.forEach(i=> arr[i]=base);
    for(let k=0;k<rem;k++) arr[activeIdx[k % nAct]]++;
    return arr;
  };
  const ongArr  = splitEven(ongTot);
  const lainArr = splitEven(lainTot);
  ongArr.forEach((v,i)=> (document.getElementById(`rOng_${i}`).textContent = fmt(v)));
  lainArr.forEach((v,i)=> (document.getElementById(`rLain_${i}`).textContent = fmt(v)));

  // --- TOTAL per orang (subtotal + ongkir + lain) ---
  const total = per.map((v,i)=> v + ongArr[i] + lainArr[i]);
  const gTot = total.reduce((a,b)=>a+b,0);
  total.forEach((v,i)=> (document.getElementById(`rTot_${i}`).textContent = fmt(v)));
  document.getElementById('rTot_total').textContent = fmt(gTot);

  // --- BASIS & Persentase tampilan ---
  const basis = (document.getElementById('basis').value || '').trim().toUpperCase();
  document.getElementById('badge').textContent = basis;
  const arr = (basis==='TOTAL') ? total : per;   // basis pembagian diskon
  const baseSum = arr.reduce((a,b)=>a+b,0);

  const pct = baseSum > 0 ? arr.map(v => v/baseSum) : new Array(names.length).fill(0);
  pct.forEach((p,i)=> (document.getElementById(`rPct_${i}`).textContent = (p*100).toFixed(2)+'%'));

  // --- Distribusi diskon: hanya ke yang arr[i] > 0, dan tidak boleh melebihi total[i] ---
  let discArr = new Array(names.length).fill(0);
  const eligibleIdx = arr.map((v,i)=> v>0 ? i : -1).filter(i=> i>=0);

  if (discTot > 0 && baseSum > 0 && eligibleIdx.length > 0) {
    // alokasi awal (floor)
    discArr = arr.map(v => Math.floor(discTot * (v / baseSum)));

    // sisa akibat pembulatan
    let allocated = discArr.reduce((a,b)=>a+b,0);
    let remain = discTot - allocated;

    // bagi sisa 1-per-1 ke yang eligible
    let k = 0;
    while (remain > 0) {
      const i = eligibleIdx[k % eligibleIdx.length];
      discArr[i]++; remain--; k++;
    }

    // clamp: tidak boleh melebihi total orang tsb
    let overflow = 0;
    discArr = discArr.map((d,i)=>{
      const cap = total[i];
      if (d > cap) { overflow += (d - cap); return cap; }
      return d;
    });

    // redistribusi overflow ke yang masih punya ruang
    if (overflow > 0) {
      const roomIdx = eligibleIdx.filter(i => discArr[i] < total[i]);
      let j = 0;
      while (overflow > 0 && roomIdx.length > 0) {
        const i = roomIdx[j % roomIdx.length];
        if (discArr[i] < total[i]) { discArr[i]++; overflow--; }
        j++;
      }
      // jika masih ada overflow, biarkan (lebih aman daripada menjadi negatif)
    }
  }

  // tampilkan diskon per orang
  discArr.forEach((v,i)=> (document.getElementById(`rDisc_${i}`).textContent = fmt(v)));

  // --- NET (tidak negatif) ---
  const net = total.map((v,i)=> Math.max(0, v - discArr[i]));
  const gNet = net.reduce((a,b)=>a+b,0);
  net.forEach((v,i)=> (document.getElementById(`rNet_${i}`).textContent = fmt(v)));
  document.getElementById('rNet_total').textContent = fmt(gNet);
}


/* ---------- Capture JPG ---------- */
async function captureJPG() {
  recalc();
  document.body.classList.add('capturing');
  const root = document.getElementById('capture-root');
  const scale = Math.min((window.devicePixelRatio || 1) * 2, 3);

  try {
    const canvas = await html2canvas(root, {
      backgroundColor: '#ffffff',
      scale,
      useCORS: true,
      allowTaint: true,
      windowWidth: document.documentElement.scrollWidth,
      windowHeight: document.documentElement.scrollHeight
    });

    // --- 1) DOWNLOAD sebagai JPG (pakai blob biar hemat memori) ---
    const jpgBlob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', 0.92));
    const jpgUrl = URL.createObjectURL(jpgBlob);
    const a = document.createElement('a');
    a.href = jpgUrl;
    a.download = `debit-note-${Date.now()}.jpg`;
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(jpgUrl);

    // --- 2) COPY ke clipboard sebagai PNG (format yang didukung) ---
    if (navigator.clipboard && window.ClipboardItem) {
      const pngBlob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
      await navigator.clipboard.write([
        new ClipboardItem({ 'image/png': pngBlob })
      ]);
      alert('‚úÖ JPG diunduh & gambar (PNG) sudah disalin ke clipboard. Tinggal paste di WA/Docs!');
    } else {
      alert('üì• JPG diunduh. Browser ini belum mendukung auto-copy gambar ke clipboard.');
    }

  } catch (err) {
    alert('Gagal membuat JPG: ' + (err?.message || err));
    console.error(err);
  } finally {
    document.body.classList.remove('capturing');
  }
}
/* ---------- End Capture JPG ---------- */

document.getElementById('addRow').addEventListener('click', ()=>addRow());
document.getElementById('addPerson').addEventListener('click', addPerson);
document.getElementById('clearAll').addEventListener('click', clearAll);
document.getElementById('basis').addEventListener('change', recalc);
document.getElementById('printBtn').addEventListener('click', ()=>{ recalc(); window.print(); });
document.getElementById('jpgBtn').addEventListener('click', captureJPG);
document.addEventListener('input', e=>{ if(e.target.classList.contains('money')) recalc(); });
document.addEventListener('keyup', e=>{ if(e.target.classList.contains('money')) recalc(); });
document.addEventListener('change', e=>{ if(e.target.classList.contains('money')) recalc(); });

  // --- Aktifkan edit nama kolom di header ---
function hookHeaderRename(){
  const hdr = document.getElementById('hdr');
  const ths = [...hdr.cells];
  ths.forEach((th, idx) => {
    // Lewati kolom pertama (MENU) dan terakhir (TOTAL)
    if (idx === 0 || idx === ths.length - 1) return;

    th.style.cursor = 'pointer';
    th.title = 'Klik untuk ganti nama';

    // Hindari dobel-attach saat rebuild
    th.dataset.renamable = '1';
    th.onclick = () => {
      const i = idx - 1;                  // index dalam array names
      const current = names[i] || '';
      const nm = prompt('Ganti nama orang:', current);
      if (nm == null) return;             // batal
      const newName = nm.trim().toUpperCase();
      if (!newName) return;               // kosong, abaikan

      names[i] = newName;                 // update sumber kebenaran
      th.textContent = newName;           // update label header-nya

      // Tidak perlu rebuild footer/body karena id footer berbasis index,
      // dan kolom data tetap di posisi yang sama.
    };
  });
}

function boot(){
  rebuildHeader(); rebuildFooter();
  for(let i=0;i<10;i++) addRow();
  recalc();
}
boot();
</script>
</body>
</html>







