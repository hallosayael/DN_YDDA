<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Debit Note Makan Siang</title>
<style>
  :root{--bg:#f8fafc;--card:#fff;--line:#e5e7eb;--ink:#0f172a;--muted:#64748b;--accent:#fef3c7;--hi:#fef08a;--blue:#e0f2fe}
  *{box-sizing:border-box}
  body{font-family:Inter,system-ui,Segoe UI,Arial,sans-serif;background:var(--bg);color:var(--ink);margin:0;padding:24px}
  .wrap{max-width:1120px;margin:0 auto;background:var(--card);border:1px solid var(--line);border-radius:16px;box-shadow:0 10px 24px rgba(2,6,23,.06)}
  header{padding:18px;border-bottom:1px solid var(--line)} h1{margin:0;text-align:center;font-size:20px}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;padding:12px 18px;border-bottom:1px dashed var(--line)}
  .btn{padding:8px 12px;border:1px solid var(--line);border-radius:10px;background:#fff;cursor:pointer}
  .btn:hover{background:#f8fafc}
  select{padding:8px 10px;border:1px solid var(--line);border-radius:10px}

  .table-wrap{overflow:auto} /* <- scroll saat view biasa */
  table{width:100%;border-collapse:separate;border-spacing:0;table-layout:fixed} /* fixed layout for width control */
  /* Set lebar kolom agar fit halaman (7 nama + 1 total = 8 kolom angka) */
  thead th:first-child, tbody td:first-child, tfoot td:first-child{width:30%} /* kolom MENU */
  thead th:not(:first-child), tfoot td:not(:first-child){width:calc(70%/8)} /* 8 kolom angka termasuk TOTAL */

  th,td{border-bottom:1px solid var(--line);padding:9px 10px;text-align:right;vertical-align:middle;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
  th:first-child,td:first-child{text-align:left}
  thead th{background:#fff;position:sticky;top:0;z-index:2}
  input.money{width:100%;padding:6px 8px;border:1px solid var(--line);border-radius:8px;text-align:right}
  td:first-child input.money{text-align:left}
  .row-label{background:var(--accent);font-weight:600}
  .row-net{background:var(--hi);font-weight:700}
  .col-total{background:var(--blue);font-weight:600}
  .note{font-size:12px;color:var(--muted);padding:8px 18px 16px}

  /* ====== PRINT STYLES ====== */
  @media print {
    @page { size: A4 landscape; margin: 8mm; }  /* orientasi & margin */
    body{padding:0;background:#fff;font-size:11px}
    .wrap{max-width:none;width:100%;box-shadow:none;border:none;border-radius:0}
    header{border:none;padding:0 0 6px 0}
    .toolbar,.note{display:none !important}
    .table-wrap{overflow:visible}         /* jangan ada scroll di print */
    thead th{position:static}             /* non-sticky saat cetak */
    th,td{padding:6px 6px}                /* rapatkan sedikit */
    input.money{
      border:none !important; outline:none !important; background:transparent !important;
      padding:0 !important; width:100% !important; text-align:right;
    }
    td:first-child input.money{text-align:left}
    .col-total{background:#fff !important}
    .row-label{background:#fff7d1 !important}
    .row-net{background:#fff3a3 !important}
  }
</style>
</head>
<body>
<div class="wrap">
  <header><h1>Debit Note Makan Siang</h1></header>

  <div class="toolbar">
    <button class="btn" id="addRow">+ Tambah Menu</button>
    <button class="btn" id="addPerson">+ Tambah Nama</button>
    <button class="btn" id="clearAll">üßπ Bersihkan</button>
    <button class="btn" id="printBtn">üñ®Ô∏è Print / PDF</button>
    <span style="margin-left:auto">Basis Diskon:
      <select id="basis"><option>SUBTOTAL</option><option>TOTAL</option></select>
    </span>
  </div>

  <div class="table-wrap">
    <table id="tbl">
      <thead>
        <tr id="hdr">
          <th>MENU</th>
          <th>ICHA</th><th>WISI</th><th>SARAH</th><th>MOLI</th><th>SANTI</th><th>ANGEL</th>
          <th class="col-total">TOTAL</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
      <tfoot>
        <tr class="row-label" id="rSub"><td>SUBTOTAL (menu)</td></tr>
        <tr class="row-label" id="rOng"><td>ONGKIR (TOTAL)</td></tr>
        <tr class="row-label" id="rLain"><td>LAIN-LAIN (TOTAL)</td></tr>
        <tr class="row-label" id="rTot"><td>TOTAL (Subtotal + Ongkir + Lain)</td></tr>
        <tr class="row-label" id="rPct"><td>% (berdasar <span id="badge">SUBTOTAL</span>)</td></tr>
        <tr class="row-label" id="rDisc"><td>DISC (TOTAL)</td></tr>
        <tr class="row-net"  id="rNet"><td>NET = Total ‚àí Disc</td></tr>
      </tfoot>
    </table>
  </div>

  <div class="note">Ketik <b>10000</b>, <b>10.000</b>, atau <b>10,000</b> di kolom ongkir/diskon‚Äîsemua dibaca sebagai 10.000.</div>
</div>

<script>
/* ===== Utils ===== */
const fmtID = new Intl.NumberFormat('id-ID');
const fmt = n => fmtID.format(Math.round(n));
const cleanNumber = v => {
  const s = (v ?? '').toString().replace(/[^\d\-]/g,'');
  if (!s || s === '-' || s === '--') return 0;
  return parseInt(s,10) || 0;
};

let names = ["ICHA","WISI","SARAH","MOLI","SANTI","ANGEL"];
const tbody = document.getElementById('tbody');

function rebuildHeader(){
  document.getElementById('hdr').innerHTML =
    '<th>MENU</th>' + names.map(n=>`<th>${n}</th>`).join('') + '<th class="col-total">TOTAL</th>';
}
function rebuildFooter(){
  const rows = [
    ['rSub', false],
    ['rOng',  true],
    ['rLain', true],
    ['rTot', false],
    ['rPct', false],
    ['rDisc', true],
    ['rNet', false],
  ];
  rows.forEach(([id,withInp])=>{
    const tr = document.getElementById(id);
    tr.querySelectorAll('td:not(:first-child)').forEach(td=>td.remove());
    names.forEach((_,i)=>{
      const td = document.createElement('td'); td.id = `${id}_${i}`; tr.appendChild(td);
    });
    const tdTot = document.createElement('td'); tdTot.className='col-total';
    if(withInp){
      const inp = document.createElement('input');
      inp.type = 'text'; inp.className='money'; inp.placeholder='0'; inp.id = `${id}_total`;
      const handle = e => { e.target.dataset.value = String(cleanNumber(e.target.value)); recalc(); };
      inp.addEventListener('input', handle); inp.addEventListener('change', handle); inp.addEventListener('keyup', handle);
      tdTot.appendChild(inp);
    } else tdTot.id = `${id}_total`;
    tr.appendChild(tdTot);
  });
}

function addRow(label=''){
  const tr = document.createElement('tr');
  const first = document.createElement('td');
  const nameIn = document.createElement('input'); nameIn.type='text'; nameIn.className='money'; nameIn.placeholder='Nama menu'; nameIn.style.textAlign='left'; nameIn.value=label;
  first.appendChild(nameIn); tr.appendChild(first);

  names.forEach(()=>{
    const td = document.createElement('td');
    const inp = document.createElement('input');
    inp.type='text'; inp.className='money'; inp.placeholder='0';
    const handle = e => { e.target.dataset.value = String(cleanNumber(e.target.value)); recalc(); };
    inp.addEventListener('input', handle); inp.addEventListener('change', handle); inp.addEventListener('keyup', handle);
    td.appendChild(inp); tr.appendChild(td);
  });

  const total = document.createElement('td'); total.className='col-total'; total.textContent='0'; tr.appendChild(total);
  tbody.appendChild(tr);
}

function addPerson(){
  const nm = prompt('Nama orang baru?'); if(!nm) return;
  names.push(nm.toUpperCase());
  rebuildHeader(); rebuildFooter();
  [...tbody.rows].forEach(tr=>{
    const td = document.createElement('td');
    const inp= document.createElement('input');
    inp.type='text'; inp.className='money'; inp.placeholder='0';
    const handle = e => { e.target.dataset.value = String(cleanNumber(e.target.value)); recalc(); };
    inp.addEventListener('input', handle); inp.addEventListener('change', handle); inp.addEventListener('keyup', handle);
    td.appendChild(inp);
    tr.insertBefore(td, tr.lastElementChild);
  });
  recalc();
}

function clearAll(){
  document.querySelectorAll('input.money').forEach(i=>{ i.value=''; i.dataset.value='0'; });
  recalc();
}

/* ===== Core calc ===== */
function recalc(){
  const per = new Array(names.length).fill(0);

  // hitung total per baris + subtotal per orang
  [...tbody.rows].forEach(tr=>{
    const inputs = [...tr.querySelectorAll('td input.money')].slice(1); // skip nama menu
    const vals = inputs.map(i => cleanNumber(i.value || i.dataset.value));
    const rowTot = vals.reduce((a,b)=>a+b,0);
    tr.lastElementChild.textContent = fmt(rowTot);
    vals.forEach((v,i)=> per[i]+=v);
  });

  // SUBTOTAL
  const gSub = per.reduce((a,b)=>a+b,0);
  per.forEach((v,i)=> (document.getElementById(`rSub_${i}`).textContent = fmt(v)));
  document.getElementById('rSub_total').textContent = fmt(gSub);

  // peserta aktif
  const activeIdx = per.map((v,i)=> v>0?i:-1).filter(i=>i>=0);
  const nAct = activeIdx.length || 1;

  // ambil total ongkir/lain/diskon
  const getTotalFrom = id => {
    const el = document.getElementById(`${id}_total`);
    if (!el) return 0;
    return cleanNumber(el.value || el.dataset.value);
  };
  const ongTot  = getTotalFrom('rOng');
  const lainTot = getTotalFrom('rLain');
  const discTot = getTotalFrom('rDisc');

  // bagi rata ongkir/lain (base + remainder)
  const splitEven = total => {
    const arr = new Array(names.length).fill(0);
    if(total===0 || nAct===0) return arr;
    const base = Math.floor(total / nAct);
    let rem = total - base*nAct;
    activeIdx.forEach(i=> arr[i]=base);
    for(let k=0;k<rem;k++) arr[activeIdx[k % nAct]]++;
    return arr;
  };
  const ongArr  = splitEven(ongTot);
  const lainArr = splitEven(lainTot);
  ongArr.forEach((v,i)=> (document.getElementById(`rOng_${i}`).textContent = fmt(v)));
  lainArr.forEach((v,i)=> (document.getElementById(`rLain_${i}`).textContent = fmt(v)));

  // TOTAL
  const total = per.map((v,i)=> v + ongArr[i] + lainArr[i]);
  const gTot = total.reduce((a,b)=>a+b,0);
  total.forEach((v,i)=> (document.getElementById(`rTot_${i}`).textContent = fmt(v)));
  document.getElementById('rTot_total').textContent = fmt(gTot);

  // Persentase (basis)
  const basis = (document.getElementById('basis').value || '').trim().toUpperCase();
  document.getElementById('badge').textContent = basis;
  const arr = basis==='TOTAL' ? total : per;
  const baseSum = arr.reduce((a,b)=>a+b,0) || 1;
  const pct = arr.map(v=> v/baseSum);
  pct.forEach((p,i)=> (document.getElementById(`rPct_${i}`).textContent = (p*100).toFixed(2)+'%'));

  // Diskon proporsional + koreksi pembulatan
  let discArr = pct.map(p=> Math.round(discTot*p));
  let dSum = discArr.reduce((a,b)=>a+b,0);
  for(let i=0; dSum<discTot; i=(i+1)%names.length){ discArr[i]++; dSum++; }
  for(let i=0; dSum>discTot; i=(i+1)%names.length){ discArr[i]--; dSum--; }
  discArr.forEach((v,i)=> (document.getElementById(`rDisc_${i}`).textContent = fmt(v)));

  // NET
  const net = total.map((v,i)=> v - discArr[i]);
  const gNet = net.reduce((a,b)=>a+b,0);
  net.forEach((v,i)=> (document.getElementById(`rNet_${i}`).textContent = fmt(v)));
  document.getElementById('rNet_total').textContent = fmt(gNet);
}

/* ===== Events & init ===== */
document.getElementById('addRow').addEventListener('click', ()=>addRow());
document.getElementById('addPerson').addEventListener('click', addPerson);
document.getElementById('clearAll').addEventListener('click', clearAll);
document.getElementById('basis').addEventListener('change', recalc);
document.getElementById('printBtn').addEventListener('click', ()=>{ recalc(); window.print(); });
document.addEventListener('input', e=>{ if(e.target.classList.contains('money')) recalc(); });
document.addEventListener('keyup', e=>{ if(e.target.classList.contains('money')) recalc(); });
document.addEventListener('change', e=>{ if(e.target.classList.contains('money')) recalc(); });

// init
function boot(){
  rebuildHeader(); rebuildFooter();
  for(let i=0;i<10;i++) addRow();
  recalc();
}
boot();
</script>
</body>
</html>
