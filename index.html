<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Debit Note Makan Siang</title>
<style>
  :root { --bg:#f8fafc; --card:#fff; --line:#e5e7eb; --ink:#0f172a; --muted:#64748b; --accent:#fef3c7; --hi:#fef08a; --blue:#e0f2fe; }
  * { box-sizing:border-box; }
  body { font-family: Inter, system-ui, sans-serif; background: var(--bg); color: var(--ink); margin: 0; padding: 16px; }
  .wrap { max-width: 1120px; margin:auto; background: var(--card); border:1px solid var(--line); border-radius:12px; box-shadow:0 8px 18px rgba(2,6,23,.06); overflow:hidden; }
  header { padding:16px; border-bottom:1px solid var(--line); text-align:center; }
  h1 { margin:0; font-size:1.2rem; }
  .toolbar { display:flex; flex-wrap:wrap; gap:6px; align-items:center; justify-content:space-between; padding:10px 16px; border-bottom:1px dashed var(--line); }
  .btn { padding:8px 10px; border:1px solid var(--line); border-radius:8px; background:#fff; cursor:pointer; font-size:0.9rem; }
  .btn:hover { background:#f8fafc; }
  select { padding:6px 8px; border:1px solid var(--line); border-radius:8px; }
  .table-wrap { width:100%; overflow-x:auto; scrollbar-width:thin; -webkit-overflow-scrolling:touch; }
  table { width:100%; border-collapse:separate; border-spacing:0; table-layout:auto; min-width:650px; }
  th,td { border-bottom:1px solid var(--line); padding:8px 10px; text-align:right; vertical-align:middle; white-space:nowrap; }
  th:first-child,td:first-child { text-align:left; }
  thead th { background:#fff; position:sticky; top:0; z-index:1; }
  input.money { width:100%; padding:6px 8px; border:1px solid var(--line); border-radius:6px; text-align:right; text-transform:uppercase; }
  td:first-child input.money { text-align:left; text-transform:uppercase; }
  .row-label { background:var(--accent); font-weight:600; }
  .row-net { background:var(--hi); font-weight:700; }
  .col-total { background:var(--blue); font-weight:600; }
  .note { font-size:0.8rem; color:var(--muted); padding:8px 16px 4px; }
  .payto { padding:16px; display:flex; align-items:center; gap:10px; border-top:2px solid var(--line); background:#fffbea; }
  .payto label { font-weight:800; font-size:1.1rem; text-transform:uppercase; }
  .payto input { flex:1; padding:10px 12px; border:2px solid var(--line); border-radius:8px; font-weight:700; font-size:1.1rem; text-transform:uppercase; background:#fffdf0; }
  .capturing thead th { position:static !important; }
  .capturing .table-wrap { overflow:visible !important; }
  @media (max-width:768px) {
    body { padding:8px; }
    .btn { flex:1; min-width:48%; font-size:0.8rem; }
    select { font-size:0.8rem; }
    h1 { font-size:1rem; }
    table { font-size:0.85rem; }
    th,td { padding:6px; }
    .payto { flex-direction:column; align-items:flex-start; }
    .payto input { width:100%; }
  }
  @media print {
    @page { size:A4 landscape; margin:8mm; }
    body { padding:0; background:#fff; font-size:11px; }
    .wrap { max-width:none; box-shadow:none; border:none; border-radius:0; }
    .toolbar,.note { display:none!important; }
    thead th { position:static; }
    input.money { border:none!important; background:transparent!important; text-align:right; padding:0!important; }
    td:first-child input.money { text-align:left; }
    .payto { border-top:2px solid #000; background:#fff; padding-top:10px; }
    .payto label,.payto input { font-weight:800; font-size:1.2rem; border:none!important; background:transparent!important; }
  }
</style>
</head>
<body>
<div class="wrap" id="pageWrap">
  <header><h1>Debit Note Makan Siang</h1></header>

  <div class="toolbar">
    <div style="display:flex;gap:6px;flex-wrap:wrap;">
      <button class="btn" id="addRow">+ Tambah Menu</button>
      <button class="btn" id="addPerson">+ Tambah Nama</button>
      <button class="btn" id="clearAll">üßπ Bersihkan</button>
      <button class="btn" id="printBtn">üñ®Ô∏è Print / PDF</button>
      <button class="btn" id="jpgTableBtn">üì∏ JPG (Tabel)</button>
      <button class="btn" id="jpgPageBtn">üì∏ JPG (Halaman)</button>
    </div>
    <div>Basis Diskon: <select id="basis"><option>TOTAL</option><option>SUBTOTAL</option></select></div>
  </div>

  <div class="table-wrap">
    <table id="tbl">
      <thead><tr id="hdr"><th>MENU</th><th>ICHA</th><th>WISI</th><th>SARAH</th><th>MOLI</th><th>SANTI</th><th>ANGEL</th><th class="col-total">TOTAL</th></tr></thead>
      <tbody id="tbody"></tbody>
      <tfoot>
        <tr class="row-label" id="rSub"><td>SUBTOTAL (menu)</td></tr>
        <tr class="row-label" id="rOng"><td>ONGKIR (TOTAL)</td></tr>
        <tr class="row-label" id="rLain"><td>LAIN-LAIN (TOTAL)</td></tr>
        <tr class="row-label" id="rTot"><td>TOTAL (Subtotal + Ongkir + Lain)</td></tr>
        <tr class="row-label" id="rPct"><td>% (berdasar <span id="badge">SUBTOTAL</span>)</td></tr>
        <tr class="row-label" id="rDisc"><td>DISC (TOTAL)</td></tr>
        <tr class="row-net" id="rNet"><td>NET = Total ‚àí Disc</td></tr>
      </tfoot>
    </table>
  </div>

  <div class="note">Ketik <b>10000</b>, <b>10.000</b>, atau <b>10,000</b> di kolom ongkir/diskon ‚Äî semua dibaca sebagai 10.000.</div>

  <div class="payto"><label>Bayar ke:</label><input id="payto" placeholder="NAMA / NOMOR REKENING / E-WALLET"></div>
</div>

<script>
/* ---------- fungsi utama kalkulasi ---------- */
const fmtID=new Intl.NumberFormat('id-ID');
const fmt=n=>fmtID.format(Math.round(n));
const clean=v=>(v??'').toString().replace(/[^\d\-]/g,'')||0;
let names=["ICHA","WISI","SARAH","MOLI","SANTI","ANGEL"];
const tbody=document.getElementById('tbody');
function rebuildHeader(){hdr.innerHTML='<th>MENU</th>'+names.map(n=>`<th>${n}</th>`).join('')+'<th class="col-total">TOTAL</th>'}
function rebuildFooter(){[['rSub',0],['rOng',1],['rLain',1],['rTot',0],['rPct',0],['rDisc',1],['rNet',0]].forEach(([id,w])=>{
 const tr=document.getElementById(id);tr.querySelectorAll('td:not(:first-child)').forEach(td=>td.remove());
 names.forEach((_,i)=>{const td=document.createElement('td');td.id=`${id}_${i}`;tr.appendChild(td)});
 const tdTot=document.createElement('td');tdTot.className='col-total';
 if(w){const inp=document.createElement('input');inp.className='money';inp.placeholder='0';inp.id=`${id}_total`;
 inp.oninput=inp.onchange=inp.onkeyup=e=>{e.target.dataset.value=clean(e.target.value);recalc()};
 tdTot.appendChild(inp)}else tdTot.id=`${id}_total`;
 tr.appendChild(tdTot);
});}
function addRow(){const tr=document.createElement('tr');const first=document.createElement('td');const nm=document.createElement('input');
nm.className='money';nm.placeholder='Nama menu';nm.style.textAlign='left';nm.style.textTransform='uppercase';first.appendChild(nm);tr.appendChild(first);
names.forEach(()=>{const td=document.createElement('td');const inp=document.createElement('input');inp.className='money';inp.placeholder='0';
inp.oninput=inp.onchange=inp.onkeyup=e=>{e.target.dataset.value=clean(e.target.value);recalc()};td.appendChild(inp);tr.appendChild(td)});
const tot=document.createElement('td');tot.className='col-total';tot.textContent='0';tr.appendChild(tot);tbody.appendChild(tr);}
function addPerson(){const nm=prompt('Nama orang baru?');if(!nm)return;names.push(nm.toUpperCase());rebuildHeader();rebuildFooter();
[...tbody.rows].forEach(tr=>{const td=document.createElement('td');const inp=document.createElement('input');inp.className='money';inp.placeholder='0';
inp.oninput=inp.onchange=inp.onkeyup=e=>{e.target.dataset.value=clean(e.target.value);recalc()};td.appendChild(inp);tr.insertBefore(td,tr.lastElementChild)});
recalc();}
function clearAll(){document.querySelectorAll('input.money').forEach(i=>{i.value='';i.dataset.value='0'});recalc();}
function recalc(){const per=new Array(names.length).fill(0);
[...tbody.rows].forEach(tr=>{const vals=[...tr.querySelectorAll('td input.money')].slice(1).map(i=>+clean(i.value||i.dataset.value));
const rowTot=vals.reduce((a,b)=>a+b,0);tr.lastElementChild.textContent=fmt(rowTot);vals.forEach((v,i)=>per[i]+=v)});
const gSub=per.reduce((a,b)=>a+b,0);per.forEach((v,i)=>rSub_[i].textContent=fmt(v));rSub_total.textContent=fmt(gSub);
const act=per.map((v,i)=>v>0?i:-1).filter(i=>i>=0),n=act.length||1;
const get=id=>+clean((document.getElementById(`${id}_total`)||{}).value||0);
const [ong,lain,disc]=['rOng','rLain','rDisc'].map(get);
const even=t=>{const a=new Array(names.length).fill(0);if(!t||!n)return a;const b=Math.floor(t/n);let r=t-b*n;act.forEach(i=>a[i]=b);for(let k=0;k<r;k++)a[act[k%n]]++;return a};
const aO=even(ong),aL=even(lain);
aO.forEach((v,i)=>rOng_[i].textContent=fmt(v));aL.forEach((v,i)=>rLain_[i].textContent=fmt(v));
const tot=per.map((v,i)=>v+aO[i]+aL[i]),gTot=tot.reduce((a,b)=>a+b,0);
tot.forEach((v,i)=>rTot_[i].textContent=fmt(v));rTot_total.textContent=fmt(gTot);
const base=(basis.value||'').toUpperCase(),arr=base==='TOTAL'?tot:per,s=arr.reduce((a,b)=>a+b,0)||1,pct=arr.map(v=>v/s);
pct.forEach((p,i)=>rPct_[i].textContent=(p*100).toFixed(2)+'%');
let dArr=pct.map(p=>Math.round(disc*p)),sum=dArr.reduce((a,b)=>a+b,0);
for(let i=0;sum<disc;i=(i+1)%names.length)dArr[i]++,sum++;
for(let i=0;sum>disc;i=(i+1)%names.length)dArr[i]--,sum--;
dArr.forEach((v,i)=>rDisc_[i].textContent=fmt(v));
const net=tot.map((v,i)=>v-dArr[i]),gNet=net.reduce((a,b)=>a+b,0);
net.forEach((v,i)=>rNet_[i].textContent=fmt(v));rNet_total.textContent=fmt(gNet);}
addRow();for(let i=0;i<9;i++)addRow();rebuildFooter();recalc();
addRowBtn.onclick=addRow;addPersonBtn?.addEventListener('click',addPerson);
clearAllBtn?.addEventListener('click',clearAll);printBtn.onclick=()=>{recalc();print()};
document.addEventListener('input',e=>e.target.classList.contains('money')&&recalc());

/* ---------- capture + clipboard ---------- */
async function ensureHtml2Canvas(){
 if(window.html2canvas)return window.html2canvas;
 await new Promise((r,j)=>{const s=document.createElement('script');s.src='https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js';s.onload=r;s.onerror=j;document.head.appendChild(s);});
 return window.html2canvas;
}
async function copyCanvasToClipboard(cv){return new Promise(res=>cv.toBlob(async b=>{if(!b)return res(false);try{if(navigator.clipboard&&window.ClipboardItem){await navigator.clipboard.write([new ClipboardItem({[b.type]:b})]);res(true);}else res(false);}catch{res(false);}},'image/png',0.95));}
async function captureNodeAsJPG(node,name){const h2c=await ensureHtml2Canvas();recalc();
const wrap=document.getElementById('pageWrap');wrap.classList.add('capturing');
const ow=node.style.width;node.style.width=node.scrollWidth+'px';
const cv=await h2c(node,{backgroundColor:'#fff',scale:2,useCORS:true,width:node.scrollWidth,height:node.scrollHeight});
node.style.width=ow;wrap.classList.remove('capturing');
const a=document.createElement('a'),ts=new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
a.download=`${name}-${ts}.jpg`;a.href=cv.toDataURL('image/jpeg',0.95);a.click();
await copyCanvasToClipboard(cv).then(ok=>{if(!ok)console.warn('Clipboard gagal / perlu izin HTTPS');});
}
jpgTableBtn.onclick=()=>captureNodeAsJPG(tbl,'debit-note-tabel');
jpgPageBtn.onclick=()=>captureNodeAsJPG(pageWrap,'debit-note-halaman');
</script>
</body>
</html>